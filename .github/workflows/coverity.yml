name: Coverity Scan

on:
  workflow_dispatch:
  push:
    branches: [ main ]
  pull_request:

jobs:
  coverity:
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Restore Coverity Analysis
        id: cache-coverity
        uses: actions/cache@v4
        with:
          path: cov-analysis
          key: ${{ runner.os }}-coverity-2024.12

      - name: Download Coverity Analysis
        if: steps.cache-coverity.outputs.cache-hit != 'true'
        run: |
          mkdir -p cov-analysis
          curl -sSL "$COVERITY_DOWNLOAD_URL" -o coverity.tgz
          tar -xzf coverity.tgz -C cov-analysis --strip-components=1
        env:
          COVERITY_DOWNLOAD_URL: ${{ secrets.COVERITY_DOWNLOAD_URL }}

      - name: Add Coverity to PATH
        run: echo "${{ github.workspace }}/cov-analysis/bin" >> "$GITHUB_PATH"

      - name: Build C demo under Coverity
        run: cov-build --dir cov-int make -C c_examples demo

      - name: Analyze captured data
        run: cov-analyze --dir cov-int --all --security

      - name: Submit results to Coverity Connect
        run: |
          cov-commit-defects \
            --dir cov-int \
            --url "$COVERITY_URL" \
            --stream "$COVERITY_STREAM" \
            --user "$COVERITY_USER" \
            --password "$COVERITY_PASSPHRASE"
        env:
          COVERITY_URL: ${{ secrets.COVERITY_URL }}
          COVERITY_STREAM: ${{ secrets.COVERITY_STREAM }}
          COVERITY_USER: ${{ secrets.COVERITY_USER }}
          COVERITY_PASSPHRASE: ${{ secrets.COVERITY_PASSPHRASE }}
